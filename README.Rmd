---
title: "rfsa: A package for accessing and analyzing USDA Farm Service Agency data"
output:
  github_document:
    toc: true
    toc_depth: 2
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set( 
  collapse = TRUE, 
  comment = "#>",  
  fig.path = "man/figures/README-", 
  out.width = "100%",
  cache = FALSE  
) 

devtools::load_all()
library(dplyr)
library(kableExtra)
library(knitr)

```

```{r data_set_table, include=FALSE, cache=FALSE}
  # initialize a dataframe with the columns "dataset","rows","columns","years","description"
  df <- data.frame(dataset = character(),
                   rows = integer(),
                   columns = integer(),
                   years = character(),
                   description = character(),
                   last_updated = character(),
                   data_downlod_date = character(),
                   included_columns = character(),
                   stringsAsFactors = FALSE)
  
  # fill in the dataframe with the dataset names, number of rows, number of columns, years, and description using the files in "./data"
  for(f in list.files("./data", pattern = "\\.rda$")){
    # load the dataset
    load(paste0("./data/", f))
    
    # get the name of the dataset
    name <- gsub("\\.rda$", "", f)
    
    # get the number of rows and columns
    rows <- nrow(get(name))
    columns <- ncol(get(name))
    
    if("program_year" %in% colnames(get(name))){
      years = get(name)$program_year
    } else if ("marketing_year" %in% colnames(get(name))){ 
      years = as.numeric(substr(get(name)$marketing_year, 1, 4))
    } else {
      years = get(name)$year
      if(is.character(years)){
        years = as.numeric(substr(years, 1, 4))
      }
    }
    

    
    # get the years covered by the dataset
    min_year = min(years, na.rm = T)
    min_year = ifelse(min_year < 2014, 2014, min_year)
    max_year = max(years, na.rm = T)
    years <- paste0( min_year, "-", max_year)
    
    # get the dates on the file f
    file_info <- file.info(paste0("./data/", f))
    
    # get the last modified date
    last_modified <- file_info$mtime
    
    # keep only the date part in d/m/y format
    last_modified <- format(last_modified, "%m/%d/%Y")
    
    # find the folder in "/data-raw/fsaArcPlc/input_data" that matches the dataset name
    folder <- list.files(path = "./data-raw/fsaArcPlc/input_data", pattern = name, full.names = TRUE)
  
    # if the folder exists, locate the file that contains `current_year` in the name
    if(length(folder) > 0){
      # find the file corresponding to the most recent year
      current_year_file = NULL
      current_year = 2030
      while(length(current_year_file) == 0 && current_year > 2013){
        # get the file that contains `current_year` in the name
        current_year_file <- list.files(path = folder, pattern = paste0(current_year), full.names = TRUE)
        # decrease the year
        current_year <- current_year - 1
      }
      
      if(length(current_year_file) == 0){
        # if the file does not exist, set the date to NA
        data_downlod_date <- NA
      } else {
        # if the file exists, get the last modified date of the file
        file_info <- file.info(current_year_file)
        
        # get the last modified date
        data_downlod_date <- file_info$mtime
        
        # keep only the date part in d/m/y format
        data_downlod_date <- format(data_downlod_date, "%m/%d/%Y")
      }
    }
      
  
    
    # add a row to the dataframe
    df <- rbind(df, data.frame(dataset = name,
                                rows = rows,
                                columns = columns,
                                years = years,
                                last_updated = last_modified,
                                data_downlod_date = data_downlod_date,
                                included_columns = paste(colnames(get(name)), collapse = ", "),
                                stringsAsFactors = FALSE))
    }

  # define descriptions of the data set
  descriptions_list = list()
  
  # list each file in ./man
  man_files <- list.files(path = "./man", pattern = "\\.Rd$", full.names = TRUE)
  
  # loop through each file
  for(m in man_files){
    # get the name of the dataset
    name <- gsub("\\.Rd$", "", basename(m))
    
    # Read the .Rd file
    rd_lines <- readLines(m)
    
    # Extract the line with the \title{} field
    title_line <- grep("^\\\\title\\{", rd_lines, value = TRUE)
    
    # Remove the LaTeX command and extract the content
    title_text <- sub("^\\\\title\\{(.*)\\}$", "\\1", title_line)
  
    # add the description to the list
    descriptions_list[[name]] <- title_text
  }

  # merge the descriptions into the dataframe
  df <- df %>%
    left_join(data.frame(dataset = names(descriptions_list),
                         description = unlist(descriptions_list)),
              by = "dataset") %>%
    mutate(description = ifelse(is.na(description), "No description available", description))
  

# rename df columns
colnames(df) <- c("Dataset", "Rows", "Columns", "Years", "Last Updated", "Data Download Date", "Included Columns" ,"Description")

# reorder the columns
df <- df[,c("Dataset", "Description", "Rows", "Years", "Last Updated", "Data Download Date", "Included Columns")]

```
# Installation
`rfsa` can be installed directly from GitHub using `remotes::install_github("dylan-turner25/rfsa", force = TRUE)`.

# Usage
The`rfsa` package has no exported functions. To load an included data set use the `data()` function with one of the names of the data sets listed in the table below. For example, to load the `fsaMyaPrice` data set, use the following code:
```{r}
# load the rfsa package
library(rfsa)

# load marketing year average prices
data("fsaMyaPrice")
 
head(fsaMyaPrice)

```

# ARC and PLC Program Data
The following table reports the currently available data sets related to ARC and PLC in the `rfsa` package. The `Last Updated` column indicates the last time the data set was updated in the package. The `Data Download Date` indicates the date that the raw input data for the current year was downloaded from the FSA website (this is important as these data sets are sometimes revised or contain projected values for in progress marketing years).

```{r, include = TRUE, echo = FALSE, cache=FALSE}
 knitr::kable(df) 
``` 

# FSA Individual Payment Files

The USDA Farm Service Agency makes available Individual Payment Files that contain payment information for programs administered by FSA. 



# Data Validation Checks

The following table contains data validation checks. These are comparisons between values derived from the `rfsa` package functions against the same values obtained from another source. For example, the first row calculates total ARC-CO payments in program year 2023 using the `get_fsa_payments()` function and compares it to the total ARC-CO payments in program year 2023 from an aggregated file on the FSA website. The `check_passed` column indicates whether the difference between the two values is less than 1%. If you are reading this and have a value of interest that you would like to see added to this table, please open an issue on the GitHub repository with the relevant information including code to generate the value using the `rfsa` package as well as an external source to validate the value against.

```{r, echo = F}

# create a data frame with columns for dataset name, code, package generated value, external value, external source
df <- data.frame(dataset = character(),
                 code = character(),
                 package_value = numeric(),
                 external_value = numeric(),
                 external_source = character(),
                 stringsAsFactors = FALSE)

# add a row for ARC-CO payments in program year 2023
metric = as.numeric(get_fsa_payments(year = 2023,program = c("ARC-CO"),year_type = "program",aggregation = "national")[,"payment_amount"])
external_value = 461724994.11
percentage_difference = (metric - external_value)/(external_value) 
df <- rbind(df, data.frame(value = "National ARC-CO payments in program year 2023",
                             code = 'get_fsa_payments(year = 2023,program = c("ARC-CO"),year_type = "program",aggregation = "national")[,"payment_amount"]',
                             package_value = metric,
                             external_value = external_value,
                             external_source = "https://www.fsa.usda.gov/sites/default/files/2025-01/ARCCO%20Non-ProgYr%20Specific%20Payment%20Data%20%282025-01-06%29.xlsx",
                             percentage_difference = paste0("%",round((percentage_difference * 100),4)),
                             check_passed = ifelse(abs(percentage_difference) < .01,
                                                    cell_spec("✓",   
                                                    format    = "html",
                                                    color     = "white",
                                                    background= "forestgreen",
                                                    bold      = TRUE),
                                                    # red box, white cross
                                                    cell_spec("✗",
                                                    format    = "html",
                                                    color     = "white",
                                                    background= "firebrick",
                                                    bold      = TRUE)),
                             stringsAsFactors = FALSE))


# add a row for ARC-CO payments in program year 2023 using the ARC/PLC program data
data("fsaArcPlcPayments") 
metric = fsaArcPlcPayments %>%
filter(program == "ARC-CO", program_year == 2023) %>%
group_by(program_year) %>%
summarize(payments = sum(payments))
metric = metric$payments
external_value = 461724994.11
percentage_difference = (metric - external_value)/(external_value) 
df <- rbind(df, data.frame(value = "National ARC-CO payments in program year 2023",
                             code =  'data(fsaArcPlcPayments); fsaArcPlcPayments %>% filter(program == "ARC-CO", program_year == 2023) %>% group_by(program_year) %>% summarize(payments = sum(payments))',
                             package_value = metric,
                             external_value = external_value,
                             external_source = "https://www.fsa.usda.gov/sites/default/files/2025-01/ARCCO%20Non-ProgYr%20Specific%20Payment%20Data%20%282025-01-06%29.xlsx",
                             percentage_difference = paste0("%",round((percentage_difference * 100),4)),
                             check_passed = ifelse(abs(percentage_difference) < .01,
                                                    cell_spec("✓",   
                                                    format    = "html",
                                                    color     = "white",
                                                    background= "forestgreen",
                                                    bold      = TRUE),
                                                    # red box, white cross
                                                    cell_spec("✗",
                                                    format    = "html",
                                                    color     = "white",
                                                    background= "firebrick",
                                                    bold      = TRUE)),
                             stringsAsFactors = FALSE))




knitr::kable(df)


```


