---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  cache = FALSE 
)

library(dplyr)
```

```{r data_set_table, include=FALSE, cache=FALSE}
  # initialize a dataframe with the columns "dataset","rows","columns","years","description"
  df <- data.frame(dataset = character(),
                   rows = integer(),
                   columns = integer(),
                   years = character(),
                   description = character(),
                   last_updated = character(),
                   data_downlod_date = character(),
                   stringsAsFactors = FALSE)
  
  # fill in the dataframe with the dataset names, number of rows, number of columns, years, and description using the files in "./data"
  for(f in list.files("./data", pattern = "\\.rda$")){
    # load the dataset
    load(paste0("./data/", f))
    
    # get the name of the dataset
    name <- gsub("\\.rda$", "", f)
    
    # get the number of rows and columns
    rows <- nrow(get(name))
    columns <- ncol(get(name))
    
    # if year is a character, keep the first four characters then convert to numeric
    if(is.character(get(name)$year)){
      years <- as.numeric(substr(get(name)$year, 1, 4))
    } else {
      years <- get(name)$year
    }
    
    # get the years covered by the dataset
    min_year = min(years, na.rm = T)
    min_year = ifelse(min_year < 2014, 2014, min_year)
    max_year = max(years, na.rm = T)
    years <- paste0( min_year, "-", max_year)
    
    # get the dates on the file f
    file_info <- file.info(paste0("./data/", f))
    
    # get the last modified date
    last_modified <- file_info$mtime
    
    # keep only the date part in d/m/y format
    last_modified <- format(last_modified, "%m/%d/%Y")
    
    # find the folder in "/data-raw/fsaArcPlc/input_data" that matches the dataset name
    folder <- list.files(path = "./data-raw/fsaArcPlc/input_data", pattern = name, full.names = TRUE)
  
    # if the folder exists, locate the file that contains `current_year` in the name
    if(length(folder) > 0){
      # find the file corresponding to the most recent year
      current_year_file = NULL
      current_year = 2030
      while(length(current_year_file) == 0 && current_year > 2013){
        # get the file that contains `current_year` in the name
        current_year_file <- list.files(path = folder, pattern = paste0(current_year), full.names = TRUE)
        # decrease the year
        current_year <- current_year - 1
      }
      
      if(length(current_year_file) == 0){
        # if the file does not exist, set the date to NA
        data_downlod_date <- NA
      } else {
        # if the file exists, get the last modified date of the file
        file_info <- file.info(current_year_file)
        
        # get the last modified date
        data_downlod_date <- file_info$mtime
        
        # keep only the date part in d/m/y format
        data_downlod_date <- format(data_downlod_date, "%m/%d/%Y")
      }
    }
      
  
    
    # add a row to the dataframe
    df <- rbind(df, data.frame(dataset = name,
                                rows = rows,
                                columns = columns,
                                years = years,
                                last_updated = last_modified,
                                data_downlod_date = data_downlod_date,
                                stringsAsFactors = FALSE))
    }

  # define descriptions of the data set
  descriptions_list = list()
  
  # list each file in ./man
  man_files <- list.files(path = "./man", pattern = "\\.Rd$", full.names = TRUE)
  
  # loop through each file
  for(m in man_files){
    # get the name of the dataset
    name <- gsub("\\.Rd$", "", basename(m))
    
    # Read the .Rd file
    rd_lines <- readLines(m)
    
    # Extract the line with the \title{} field
    title_line <- grep("^\\\\title\\{", rd_lines, value = TRUE)
    
    # Remove the LaTeX command and extract the content
    title_text <- sub("^\\\\title\\{(.*)\\}$", "\\1", title_line)
  
    # add the description to the list
    descriptions_list[[name]] <- title_text
  }

  # merge the descriptions into the dataframe
  df <- df %>%
    left_join(data.frame(dataset = names(descriptions_list),
                         description = unlist(descriptions_list)),
              by = "dataset") %>%
    mutate(description = ifelse(is.na(description), "No description available", description))
  

# rename df columns
colnames(df) <- c("Dataset", "Rows", "Columns", "Years", "Last Updated", "Data Download Date", "Description")
  


```
# Installation
`rfsa` can be installed directly from GitHub using `remotes::install_github("dylan-turner25/rfsa", force = TRUE)`.

# Avaliable Datasets
The following table reports the currently available data sets in the `rfsa` package. The `Last Updated` column indicates the last time the data set was updated in the package. The `Data Download Date` indicates the date that the raw input data for the current year was downloaded from the FSA website (this is important as these data sets are sometimes revised or contain projected values for in progress marketing years).

```{r, include = TRUE, echo = FALSE, cache=FALSE}
 knitr::kable(df) 
``` 
